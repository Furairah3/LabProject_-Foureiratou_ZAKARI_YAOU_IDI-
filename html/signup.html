<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Attendance Management System</title>
    <link rel="stylesheet" href="../css/mystyle.css">
</head>

<body>
    <div class="container">
        <img src="../image/Logo.png" alt="Logo" class="logo">
        <h1>Furairah's Attendance Management System</h1>
        <h2>Create Your Account</h2>

        <form id="signupForm">
            <div id="formMessage" class="general-error" style="display: none;"></div>

            <div class="form-group">
                <label for="first_name">First Name:</label>
                <input type="text" id="first_name" name="first_name" placeholder="Enter your first name" required>
                <small id="firstNameError" class="error-message"></small>
            </div>

            <div class="form-group">
                <label for="last_name">Last Name:</label>
                <input type="text" id="last_name" name="last_name" placeholder="Enter your last name" required>
                <small id="lastNameError" class="error-message"></small>
            </div>

            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" placeholder="Enter your email" required>
                <small id="emailError" class="error-message"></small>
            </div>

            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" placeholder="Create a password" required>
                <div class="password-strength">
                    <div class="strength-bar">
                        <div id="strengthFill" class="strength-fill"></div>
                    </div>
                    <div id="strengthText" class="strength-text"></div>
                </div>
                <small id="passwordError" class="error-message"></small>
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirm Password:</label>
                <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm your password" required>
                <small id="confirmPasswordError" class="error-message" style="display: none;">Passwords do not match!</small>
            </div>

            <div class="form-group">
                <label for="user_id">User ID:</label>
                <input type="text" pattern="[0-9]*" inputmode="numeric" id="user_id" name="user_id" placeholder="Enter your user ID" required>
                <small id="userIdError" class="error-message"></small>
            </div>

            <div class="form-group">
                <label for="dob">Date of Birth:</label>
                <input type="date" id="dob" name="dob" required>
                <small id="dobError" class="error-message"></small>
            </div>

            <div class="form-group">
                <label for="role">Role:</label>
                <select id="role" name="role" required>
                    <option value="">Select your role</option>
                    <option value="student">Student</option>
                    <option value="faculty">Faculty</option>
                    <option value="intern">Intern</option>
                </select>
                <small id="roleError" class="error-message"></small>
            </div>

            <!-- Student-specific fields -->
            <div id="studentFields" class="role-specific-fields">
                <div class="form-group">
                    <label for="major_id">Major:</label>
                    <select id="major_id" name="major_id">
                        <option value="">Select your major</option>
                        <option value="1">Computer Science</option>
                        <option value="2">Electrical Engineering</option>
                        <option value="3">Mechanical Engineering</option>
                        <option value="4">Business Administration</option>
                        <option value="5">Psychology</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="year_of_study">Year of Study:</label>
                    <input type="number" id="year_of_study" name="year_of_study" min="1" max="5" placeholder="Enter year of study">
                </div>
            </div>

            <!-- Faculty-specific fields -->
            <div id="facultyFields" class="role-specific-fields">
                <div class="form-group">
                    <label for="department_id">Department:</label>
                    <select id="department_id" name="department_id">
                        <option value="">Select your department</option>
                        <option value="1">Computer Science</option>
                        <option value="2">Electrical Engineering</option>
                        <option value="3">Mechanical Engineering</option>
                        <option value="4">Mathematics</option>
                        <option value="5">Physics</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="designation">Designation:</label>
                    <input type="text" id="designation" name="designation" placeholder="Enter your designation">
                </div>
            </div>

            <!-- Intern-specific fields -->
            <div id="internFields" class="role-specific-fields">
                <div class="form-group">
                    <label for="assigned_department">Assigned Department:</label>
                    <select id="assigned_department" name="assigned_department">
                        <option value="">Select assigned department</option>
                        <option value="1">IT Department</option>
                        <option value="2">HR Department</option>
                        <option value="3">Marketing</option>
                        <option value="4">Finance</option>
                        <option value="5">Operations</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="start_date">Start Date:</label>
                    <input type="date" id="start_date" name="start_date">
                </div>

                <div class="form-group">
                    <label for="end_date">End Date:</label>
                    <input type="date" id="end_date" name="end_date">
                </div>
            </div>

            <button type="submit" id="submitBtn">Register</button>
            <p>Already have an account? <a href="login.html">Login here</a></p>
            <p><a href="../index.html">‚Üê Back to Home</a></p>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const signupForm = document.getElementById('signupForm');
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const confirmPasswordError = document.getElementById('confirmPasswordError');
            const roleSelect = document.getElementById('role');
            const studentFields = document.getElementById('studentFields');
            const facultyFields = document.getElementById('facultyFields');
            const internFields = document.getElementById('internFields');
            const strengthFill = document.getElementById('strengthFill');
            const strengthText = document.getElementById('strengthText');
            const submitBtn = document.getElementById('submitBtn');
            const formMessage = document.getElementById('formMessage');

            console.log('Script loaded successfully');

            // Initialize - hide all role-specific fields
            studentFields.style.display = 'none';
            facultyFields.style.display = 'none';
            internFields.style.display = 'none';

            // Show/hide role-specific fields and clear values
            roleSelect.addEventListener('change', function() {
                console.log('Role changed to:', this.value);

                // Hide all role-specific fields
                studentFields.style.display = 'none';
                facultyFields.style.display = 'none';
                internFields.style.display = 'none';

                // Clear all role-specific field values when switching roles
                document.getElementById('major_id').value = '';
                document.getElementById('year_of_study').value = '';
                document.getElementById('department_id').value = '';
                document.getElementById('designation').value = '';
                document.getElementById('assigned_department').value = '';
                document.getElementById('start_date').value = '';
                document.getElementById('end_date').value = '';

                if (this.value === 'student') {
                    studentFields.style.display = 'block';
                } else if (this.value === 'faculty') {
                    facultyFields.style.display = 'block';
                } else if (this.value === 'intern') {
                    internFields.style.display = 'block';
                }
            });

            // Password strength indicator
            passwordInput.addEventListener('input', function() {
                const password = this.value;
                const strength = checkPasswordStrength(password);

                strengthFill.className = 'strength-fill ' + strength.level;
                strengthFill.style.width = strength.percent + '%';
                strengthText.textContent = strength.text;
                strengthText.className = 'strength-text ' + strength.level;
            });

            // Confirm password validation
            confirmPasswordInput.addEventListener('input', function() {
                const password = passwordInput.value;
                const confirmPassword = this.value;

                if (password && confirmPassword && password !== confirmPassword) {
                    confirmPasswordError.style.display = 'block';
                } else {
                    confirmPasswordError.style.display = 'none';
                }
            });

            // Form submission
            signupForm.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Form submitted');

                if (validateForm()) {
                    submitSignupForm();
                }
            });

            function checkPasswordStrength(password) {
                let strength = 0;

                if (password.length >= 8) strength++;
                if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
                if (password.match(/\d/)) strength++;
                if (password.match(/[^a-zA-Z\d]/)) strength++;

                if (password.length === 0) {
                    return {
                        level: '',
                        percent: 0,
                        text: ''
                    };
                } else if (strength <= 1) {
                    return {
                        level: 'weak',
                        percent: 33,
                        text: 'Weak'
                    };
                } else if (strength <= 2) {
                    return {
                        level: 'medium',
                        percent: 66,
                        text: 'Medium'
                    };
                } else {
                    return {
                        level: 'strong',
                        percent: 100,
                        text: 'Strong'
                    };
                }
            }

            function validateForm() {
                let isValid = true;

                // Clear previous errors
                document.querySelectorAll('.error-message').forEach(error => {
                    error.textContent = '';
                });
                formMessage.style.display = 'none';

                // First Name validation
                const firstName = document.getElementById('first_name').value.trim();
                if (!firstName) {
                    document.getElementById('firstNameError').textContent = 'First name is required';
                    isValid = false;
                }

                // Last Name validation
                const lastName = document.getElementById('last_name').value.trim();
                if (!lastName) {
                    document.getElementById('lastNameError').textContent = 'Last name is required';
                    isValid = false;
                }

                // Email validation
                const email = document.getElementById('email').value.trim();
                if (!email) {
                    document.getElementById('emailError').textContent = 'Email is required';
                    isValid = false;
                } else if (!isValidEmail(email)) {
                    document.getElementById('emailError').textContent = 'Please enter a valid email address';
                    isValid = false;
                }

                // Password validation
                const password = passwordInput.value;
                if (!password) {
                    document.getElementById('passwordError').textContent = 'Password is required';
                    isValid = false;
                } else if (password.length < 6) {
                    document.getElementById('passwordError').textContent = 'Password must be at least 6 characters';
                    isValid = false;
                }

                // Confirm password validation
                const confirmPassword = confirmPasswordInput.value;
                if (password !== confirmPassword) {
                    confirmPasswordError.style.display = 'block';
                    isValid = false;
                }

                // User ID validation
                const userId = document.getElementById('user_id').value.trim();
                if (!userId) {
                    document.getElementById('userIdError').textContent = 'User ID is required';
                    isValid = false;
                } else if (!/^\d+$/.test(userId)) {
                    document.getElementById('userIdError').textContent = 'User ID must contain only numbers';
                    isValid = false;
                }

                // Date of Birth validation
                const dob = document.getElementById('dob').value;
                if (!dob) {
                    document.getElementById('dobError').textContent = 'Date of birth is required';
                    isValid = false;
                } else {
                    const birthDate = new Date(dob);
                    const today = new Date();
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();

                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }

                    if (age < 13) {
                        document.getElementById('dobError').textContent = 'You must be at least 13 years old';
                        isValid = false;
                    }
                }

                // Role validation
                const role = roleSelect.value;
                if (!role) {
                    document.getElementById('roleError').textContent = 'Please select a role';
                    isValid = false;
                }

                // Role-specific validation
                if (role === 'faculty') {
                    const departmentId = document.getElementById('department_id').value;
                    if (!departmentId) {
                        // Make department required for faculty
                        document.getElementById('department_id').closest('.form-group').querySelector('label').innerHTML += ' <span style="color: red;">*</span>';
                        isValid = false;
                    }
                }

                return isValid;
            }

            function isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            function submitSignupForm() {
                // Create form data manually to handle empty values properly
                const formData = new FormData();
                
                // Add required fields
                formData.append('first_name', document.getElementById('first_name').value.trim());
                formData.append('last_name', document.getElementById('last_name').value.trim());
                formData.append('email', document.getElementById('email').value.trim());
                formData.append('password', document.getElementById('password').value);
                formData.append('user_id', document.getElementById('user_id').value.trim());
                formData.append('dob', document.getElementById('dob').value);
                formData.append('role', document.getElementById('role').value);
                formData.append('action', 'signup');

                // Add role-specific fields only if they have values
                const majorId = document.getElementById('major_id').value;
                const yearOfStudy = document.getElementById('year_of_study').value;
                const departmentId = document.getElementById('department_id').value;
                const designation = document.getElementById('designation').value;
                const assignedDepartment = document.getElementById('assigned_department').value;
                const startDate = document.getElementById('start_date').value;
                const endDate = document.getElementById('end_date').value;

                if (majorId) formData.append('major_id', majorId);
                if (yearOfStudy) formData.append('year_of_study', yearOfStudy);
                if (departmentId) formData.append('department_id', departmentId);
                if (designation) formData.append('designation', designation.trim());
                if (assignedDepartment) formData.append('assigned_department', assignedDepartment);
                if (startDate) formData.append('start_date', startDate);
                if (endDate) formData.append('end_date', endDate);

                // Show loading state
                submitBtn.disabled = true;
                submitBtn.textContent = 'Registering...';

                console.log('Submitting form to auth.php');

                fetch('../php/auth.php', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        console.log('Response received:', response);
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Data received:', data);
                        if (data.success) {
                            showMessage('Registration successful! Redirecting to login...', 'success');
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 2000);
                        } else {
                            showMessage(data.message || 'Registration failed. Please try again.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showMessage('An error occurred. Please check your connection and try again.', 'error');
                    })
                    .finally(() => {
                        // Reset button state
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Register';
                    });
            }

            function showMessage(message, type) {
                formMessage.textContent = message;
                formMessage.className = type === 'success' ? 'success-message' : 'general-error';
                formMessage.style.display = 'block';

                // Scroll to message
                formMessage.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest'
                });
            }
        });
    </script>
</body>
</html>
